---
title: 'TITLE'
author: "Molly Lewis, Martin Zettersten, and Gary Lupyan"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: yes
    theme: paper
    toc: yes
    toc_float: no
subtitle: Supplementary Information
---

******
******

```{r setup, include = F}
# load packages
library(tidyverse)
library(knitr)
library(here)
library(dendextend)
library(ggdendro)
library(RColorBrewer)
library(cowplot)
library(broom)
library(R.matlab)
library(heatmaply)



opts_chunk$set(echo = F, message = F, warning = F, 
               error = F, cache = F, tidy = F, fig.height = 4.5)

theme_set(theme_classic())
options(shiny.sanitize.errors = FALSE)
```  

<a href="https://github.com/mllewis/keb_2019_reanalysis" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm</style>

This document was created from an R markdown file. The respository for the project can be found here: https://github.com/mllewis/keb_2019_reanalysis.


# Card Sorting Task
```{r}
get_hclust <- function(current_sims){
  wide_sims <- current_sims %>%
    select(animal1, animal2, similarity_value) %>%
    spread(animal1, similarity_value) %>%
    select(-animal2)
  
  wide_sims_mat <- as.matrix(wide_sims)
  rownames(wide_sims_mat) <- colnames(wide_sims)
  
  wide_sims_mat %>%
    dist()%>%
    hclust()
}
TIDY_HUMAN_WIKI_DATA <- here("data/processed/tidy_human_wiki_language_data.csv")

all_data <- read_csv(TIDY_HUMAN_WIKI_DATA)

all_hclusts <- all_data %>%
  filter(!(knowledge_type %in% c("habitat", "food"))) %>%
  group_by(knowledge_source, knowledge_type)%>%
  nest() %>%
  mutate(hclusts = map(data, get_hclust)) %>%
  select(-data)
```


## Basic Clusterings {.tabset} 

Dendrograms created based on a hierarchical cluster analysis of human judgements of similarity and language-based estimates of similarity.

### Shape

```{r, fig.show = "hold", out.width = "33%", echo = F}
plot_basic_dendro <- function(current_df, kt, ks){
  lang <- current_df %>%
     filter(knowledge_type == kt,
            knowledge_source == ks) %>%
     pull(hclusts) 
  
  ggdendro::ggdendrogram(lang[[1]], rotate = T) +
            ggtitle(paste0(str_to_title(ks), " Similarity ", str_to_title(kt)))
}

plot_basic_dendro(all_hclusts, "shape", "language")
plot_basic_dendro(all_hclusts, "shape", "blind")
plot_basic_dendro(all_hclusts, "shape", "sighted")

```

### Texture

```{r, fig.show = "hold", out.width = "33%", height = 4}
plot_basic_dendro(all_hclusts, "texture", "language")
plot_basic_dendro(all_hclusts, "texture", "blind")
plot_basic_dendro(all_hclusts, "texture", "sighted")
```

### Color

```{r, fig.show = "hold", out.width = "33%"}
plot_basic_dendro(all_hclusts, "color", "language")
plot_basic_dendro(all_hclusts, "color", "blind")
plot_basic_dendro(all_hclusts, "color", "sighted")
```

## Entanglement Comparisons {.tabset}

Entanglement is a measure of how well the labels of two dendrograms are aligned. Entanglement values range from 0 (fully aligned labels) to 1 (fully mismatched labels). Entanglement is computed by numbering the labels (1 to the total number of labels) of each tree, and then computing the L-norm distance between these two vectors.

Below, we show pairwise comparisons of human judgement-based (blind and sigted participants) and language-based dendrograms in so-called tanglegrams, after using the untangle() method from the R package dendextend to minimize the amount of entanglement, i.e. to optimize the alignment of the labels from the two dendrograms without altering the underlying cluster structure. We also plot the minimum entanglement values found for each pairwise comparison (lower equals better alignment of the labels).

### Shape

```{r, fig.show = "hold", out.width = "50%"}
plot_tanglegrams <- function(current_df, kt){
  current_dends <- current_df %>%
  filter(knowledge_type == kt,
         knowledge_source %in% c("language", "blind")) %>%
  mutate(dendros = map(hclusts, as.dendrogram)) %>%
  pull(dendros)

dendlist(current_dends[[1]], current_dends[[2]]) %>%
  untangle(method = "step2side") %>%
  tanglegram(axes = F, color_lines = "black", 
             common_subtrees_color_lines = FALSE, 
             highlight_branches_lwd = FALSE,
             highlight_distinct_edges = FALSE,
             margin_inner = 5.7,
             main_left = "LANGUAGE",
             main_right = "BLIND") 

current_dends <- current_df %>%
  filter(knowledge_type == kt,
         knowledge_source %in% c("language", "sighted")) %>%
  mutate(dendros = map(hclusts, as.dendrogram)) %>%
  pull(dendros)

dendlist(current_dends[[1]], current_dends[[2]]) %>%
  untangle(method = "step2side") %>%
  tanglegram(axes = F, color_lines="black", 
             common_subtrees_color_lines = FALSE, 
             highlight_branches_lwd = FALSE,
             highlight_distinct_edges = FALSE,
             margin_inner = 5.7,
             main_left = "LANGUAGE",
             main_right = "SIGHTED") 
}

plot_tanglegrams(all_hclusts, "shape")
```

### Texture

```{r, fig.show = "hold", out.width = "50%"}
plot_tanglegrams(all_hclusts, "texture")
```

### Color

```{r, fig.show = "hold", out.width = "50%"}
plot_tanglegrams(all_hclusts, "color")
```

### Entanglement Values

```{r, fig.height = 4, fig.width = 8}
##read in data frame of cluster similarity values (created in 01_compute_cluster_similarity_values.R)
CLUSTER_PATH <- here("data/processed/cluster_similarity_values.csv")
cluster_similarity_values <- read_csv(CLUSTER_PATH)

#process into shorter dataframe
cluster_similarity <- cluster_similarity_values %>%
  rowwise() %>% 
  mutate(data_source = paste(sort(c(as.character(data_source_1), 
                                    as.character(data_source_2))), collapse = "_")) %>%  
  ungroup() %>%
  group_by(knowledge_type,data_source) %>%
  select(-data_source_1,-data_source_2) %>%
  summarise_all(min)

ggplot(cluster_similarity, aes(data_source,entangle_step2side,fill=data_source))+
  geom_bar(stat="identity")+
  ylim(0,1)+
  facet_wrap(~knowledge_type)+
  theme(legend.position="none", 
        axis.text.x  = element_text(angle=90, vjust=0.5))+
  scale_x_discrete(limits=c("blind_sighted","language_sighted","blind_language"),
                   labels=c("Blind \nto Sighted", "Language \nto Sighted","Language \nto Blind"))+
  scale_fill_brewer(palette="Set1")+
  ylab("Entanglement")+
  xlab("Clustering Comparison")
```


## Indices of Similarity between Clusterings

We also computed two indices of the similarity between the clusterings derived from human (blind and sighted participant data) and language-based similarity ratings for color, shape and texture: the Fowlkes-Mallows Index and the adjusted Rand index.

### FM-Index (z-scored)

The Fowlkes-Mallows Index (FM-Index) is computed by comparing the two hierarchical clustering trees cut at a specific level k (i.e. split into k different clusters based on the hierarchical cluster). It varies from 0 to 1, with higher values indicating greater similarity. Intuitively, the FM-Index captures the degree to which two labels tend to fall in the same cluster in both tree 1 and tree 2. The Fowlkes-Mallows index is computed as the geometric mean of the ratio of the total number of labels sharing the same cluster in both trees to the number of labels sharing the same cluster in tree 1 and the ratio of the total number of labels sharing the same cluster in both trees to the number of labels sharing the same cluster in tree 2. The FM-Index of two given hierarchical clusterings is then compared to the expected value of the FM-Index under the hypothesis of no relation between the two clusterings.

The plots depict the z-scored FM-Index for each pairwise comparison of the hierarchical cluster trees derived from the human judgement and language similarity data, after cutting the trees into k = 5, 10, 15, and 20 clusters. The dashed line shows the critical value at $\alpha = .05$ assuming a one-sided hypothesis test ($z = 1.645$, i.e. the z-score with a tail area of .05).

```{r, fig.height = 6, fig.width = 5}
cluster_similarity_Z_FM <- cluster_similarity %>%
  select(knowledge_type,data_source,Z_FM_5,Z_FM_10,Z_FM_15, Z_FM_20) %>%
  gather(cluster_num,Z_FM, Z_FM_5:Z_FM_20) %>%
  mutate(cluster_num=as.numeric(as.character(str_remove(cluster_num, "Z_FM_"))))

ggplot(cluster_similarity_Z_FM, aes(x = data_source, y = Z_FM, fill = data_source)) +
    geom_bar(stat="identity")+
    scale_x_discrete(name="",
                 limits=c("blind_sighted","language_sighted","blind_language"),
               labels=c("Blind \nto Sighted", "Language \nto Sighted","Language \nto Blind"))+
    scale_y_continuous(limits=c(-1,16))+
    geom_hline(yintercept=1.645, linetype="dashed")+
    scale_fill_brewer(palette="Set1")+
    ylab("FM Index (Z-score)")+
    xlab("Clustering Comparison")+
    facet_grid(cluster_num ~ knowledge_type)+
    theme(legend.position = "none", axis.text.x  = element_text(angle=90, vjust=0.5,size=8))
```

### Adjusted Rand Index

The Rand index is the ratio of the number of pairs of labels on which two clusterings agree (i.e. the number of pairs of labels in the same cluster in both trees and the number of pairs of labels in different clusters in both trees) to the total number of label pairs. The adjusted Rand index (here using Hubert and Arabie's method) corrects the Rand index for the number of groupings one might expect by chance alone. An adjusted Rand index of 0 indicates two clusterings have a Rand index that matches the expected value for random groupings, with higher and lower values indicating higher- or lower-than-chance level similarity between the two clusterings.

The plots depict the adjusted Rand index for each pairwise comparison of the hierarchical cluster trees derived from the human judgement and language similarity data, after cutting the trees into k = 5, 10, 15, and 20 clusters.

```{r, fig.height = 6, fig.width = 5}
cluster_similarity_adjustedRand <- cluster_similarity %>%
  select(knowledge_type,data_source,adjustedRand_5,adjustedRand_10,adjustedRand_15, adjustedRand_20) %>%
  gather(cluster_num,adjustedRand, adjustedRand_5:adjustedRand_20) %>%
  mutate(cluster_num=as.numeric(as.character(str_remove(cluster_num, "adjustedRand_"))))

ggplot(cluster_similarity_adjustedRand, aes(x = data_source, y = adjustedRand, fill = data_source)) +
    geom_bar(stat="identity")+
    scale_x_discrete(name="",
                 limits=c("blind_sighted","language_sighted","blind_language"),
               labels=c("Blind \nto Sighted", "Language \nto Sighted","Language \nto Blind"))+
    scale_y_continuous(limits=c(-0.1,1))+
    scale_fill_brewer(palette="Set1")+
    ylab("Adjusted Rand Index")+
    xlab("Clustering Comparison")+
    facet_grid(cluster_num ~ knowledge_type)+
    theme(legend.position = "none", axis.text.x  = element_text(angle=90, vjust=0.5,size=8))
```

# Taxonomic Comparision

```{r, language_wiki_data, fig.width = 6}
LANGUAGE_PATH_WIKI <- here("data/processed/animal_distances_wiki.csv")
language_data_wiki <- read_csv(LANGUAGE_PATH_WIKI) %>%
  spread(word2, language_similarity) %>%
  select(-word1)

all_corrs_mat_langs_wiki <- as.matrix(language_data_wiki)
rownames(all_corrs_mat_langs_wiki) <- colnames(language_data_wiki)

language_long_wiki <- all_corrs_mat_langs_wiki %>%
  as.data.frame() %>%
  rownames_to_column("animal1") %>%
  gather("animal2", "similarity", -animal1) %>%
  mutate(sim_type = "language_wiki")
```



```{r taxonomic_data}
OUTPATH <- here("data/processed/animal_distances_taxonomic.csv")
TAXONOMIC_PATH <- here("data/raw/taxonomy_matrix.mat")
taxonomic_data <- readMat(TAXONOMIC_PATH)[[2]]  

LABELS <- c("shark", "swan", "flamingo", "pigeon", "crow", "elephant", 
            "mammoth", "sloth", "beaver", "gorilla", "bat", "rhino", 
            "zebra", "llama", "hippo", "killerwhale", "dolphin", "giraffe",
            "sheep", "goat", "deer", "pig", "boar", "lion", "panther", "cheetah",
            "skunk", "panda", "polarbear", "grizzly") %>% rev() # from SI fig s2

colnames(taxonomic_data) <- LABELS
rownames(taxonomic_data) <- LABELS

taxonomic_long <- taxonomic_data %>%
  as.data.frame() %>%
  rownames_to_column("animal1") %>%
  gather("animal2", "similarity", -animal1) %>%
  mutate(sim_type = "taxonomy")
```
## Heatmaps{.tabset}
### Taxonomy
```{r}
heatmaply(taxonomic_data) 
```

### Language
```{r}
heatmaply(all_corrs_mat_langs_wiki) 
```

## Language - Taxonomy correlation
```{r, fig.width = 4, fig.height = 4}
tidy_long <- bind_rows(taxonomic_long, language_long_wiki) %>%
  filter(animal1 < animal2) %>%
  spread(sim_type, similarity) 

ggplot(tidy_long, aes(x = taxonomy, y = language_wiki)) +
  geom_point() + 
  geom_smooth(method = "lm") +
  ylab("Language Similarity") +
  xlab("Taxonomy (Evolution Distance)") +
  theme_classic()
  
cor.test(tidy_long$taxonomy,tidy_long$language_wiki, method = "spearman") %>%
  tidy()%>%
  kable()
```

## Taxonomic and language similarity as predictors
# Feature Choice Task (Texture)

```{r}
TIDY_HUMAN_TEXTURE <- here("data/processed/tidy_human_texture_response.csv")
LANGUAGE_SIMILARITY <- here("data/processed/animal_texture_langauge_distances_with_anchors.csv")

human_data <- read_csv(TIDY_HUMAN_TEXTURE) %>%
  rename(similarity = prop)
language_data  <- read_csv(LANGUAGE_SIMILARITY) %>%
  rename(texture = anchor,
         similarity = language_similarity)  %>%
  mutate(group = "language")

animal_order <- c("goldfish", "snake", "crocodile", "lizard", "eel", "shark", "turtle", "toad", "dolphin", "frog", "worm", "elephant", "hippo", "rhino", "pig", "platypus", "seal","ferret", "gorilla", "sheep", "fox", "bear", "horse", "donkey", "cat", "penguin", "ostrich","flamingo", "peacock", "pigeon")
```

## Reproduction of KEB Figure 6b with language data
```{r, fig.width = 8}
all_data <- bind_rows(human_data, language_data) %>%
    mutate(texture = fct_relevel(texture, "scales", "skin", "fur", "feathers"),
           group = fct_relevel(group, "S", "CB", "language"),
           group = fct_recode(group, "Sighted" = "S", "Blind" = "CB", "Language" = "language"),
           animal = fct_relevel(animal,  animal_order)) 

p1 <- all_data %>%
  filter(group != "Language") %>%
  ggplot(aes(x = texture, y = fct_rev(animal), fill = similarity))  +
  geom_tile() +
  facet_wrap(~group) +
  ylab("animal") +
  scale_fill_gradient(low = "white", high = "black", limits = c(0,1))  +
  theme_classic()+
  theme(legend.position = "bottom")
```

```{r, fig.height = 5, width = 7}
p2 <- all_data %>%
  filter(group == "Language", set_id == 0) %>%
  ggplot(aes(x = texture, y = fct_rev(animal), fill = similarity))  +
  facet_wrap(~group) +
  geom_tile() +
  ylab("animal") +
  scale_fill_gradient(low = "white", high = "black")  +
  theme_classic() +
  theme(legend.position = "bottom")

cowplot::plot_grid(p1, p2, ncol = 2,label_size = 16, rel_widths = c(2,1))
```

## Language - Human correlations
```{r, fig.width = 4, fig.height = 4}
all_language_only <- all_data %>%
  filter(group == "Language", set_id == 0) %>%
  rename(language_similarity = similarity)  %>%
  select(-group, -correct) 

lang_raw_comparison_all <- full_join(all_language_only, human_data) %>%
  mutate(group = fct_recode(group, "Sighted" = "S", "Blind" = "CB"))

ggplot(lang_raw_comparison_all, aes(x = language_similarity, y = similarity, color = group)) +
  ylab("Human Similarity") +
  xlab("Language Similarity") +
  geom_point(alpha = .8) + 
  geom_smooth(method = "lm") +
  theme_classic() +
  guides(color=guide_legend(title = "Participant Group"))

corrs <- lang_raw_comparison_all %>%
  group_by(group) %>%
  nest() %>%
  mutate(test = map(data, ~ tidy(cor.test(.x$language_similarity, .x$similarity, method = "spearman")))) %>%
  select(-data) %>%
  unnest() 

kable(corrs)
```

# Replication on Second Corpus
## Card Sorting Task
## Taxonomic Comparision
```{r, language_google_data}
LANGUAGE_PATH_GOOGLE <- here("data/processed/animal_distances_google.csv")
language_data_google <- read_csv(LANGUAGE_PATH_GOOGLE) %>%
  spread(word2, language_similarity) %>%
  select(-word1)

all_corrs_mat_lang_google <- as.matrix(language_data_google)
rownames(all_corrs_mat_lang_google) <- colnames(language_data_google)

language_long_google <- all_corrs_mat_lang_google %>%
  as.data.frame() %>%
  rownames_to_column("animal1") %>%
  gather("animal2", "similarity", -animal1) %>%
  mutate(sim_type = "language_google")

```

```{r}
heatmaply(all_corrs_mat_lang_google) 
```

```{r, fig.width = 4, fig.height = 4}
tidy_long <- bind_rows(taxonomic_long, language_long_google) %>%
  filter(animal1 < animal2) %>%
  spread(sim_type, similarity) 


ggplot(tidy_long, aes(x = taxonomy, y = language_google)) +
  geom_point() + 
  geom_smooth(method = "lm") +
  ylab("Language Similarity") +
  xlab("Taxonomy (Evolution Distance)") +
  theme_classic()
  
cor.test(tidy_long$taxonomy,tidy_long$language_google, method = "spearman") %>%
  tidy()%>%
  kable()
```

## Feature Choice Task (Texture)


# Bedny et al. (2019) Reanalysis

```{r}
BEDNY_DATA <- here("data/raw/datalong_CBSAMT.csv")
bedny_data <- read_csv(BEDNY_DATA)

sim_ratings <-bedny_data %>%
  filter(C1 == "Light", C2 == "Light") %>%
  select(contains("V"), contains("_")) %>%
  rename(word1 = V1,
         word2 = V2) %>%
  gather("subject_id", "raw_similarity", -word1, -word2) %>%
  group_by(subject_id) %>%
  mutate(scale_similarity = scale(raw_similarity),
         norm_similarity = (scale_similarity - min(scale_similarity))/
           (max(scale_similarity) - min(scale_similarity)),
         group_type = case_when(str_detect(subject_id, "CB_")~ "CB",
                                str_detect(subject_id, "S_")~ "S",
                                str_detect(subject_id, "AMT_")~ "AMT"),
         group_type = fct_recode(group_type, "Sighted" = "S", "Blind" = "CB", "Turk" = "AMT"))

mean_ratings <- sim_ratings %>%
  group_by(group_type, word1, word2) %>%
  filter(!is.na(norm_similarity))%>%
  summarize(similarity = mean(norm_similarity)) 

# get language distances
LANGUAGE_DISTANCES <- here("data/processed/bedny_2019_lang_distances.csv")
long_word_word_dists <- read_csv(LANGUAGE_DISTANCES)
```


```{r, fig.height = 3.5}
all_data <- mean_ratings %>%
  left_join(long_word_word_dists)

ggplot(all_data, aes(x = language_similarity, y = similarity))+
  geom_point() + 
  #geom_text(aes(label = word1)) +
  xlab("Language Similarity (Wikipedia Corpus)") +
  ylab("Human Similarity")+
  geom_smooth(method = "lm") +
  facet_grid(~group_type) + 
  theme_classic()
```

```{r}
all_data %>%
  rename(participant_group = group_type) %>%
  group_by(participant_group)%>%
  nest() %>%
  mutate(temp = map(data, ~tidy(cor.test(.$similarity, .$language_similarity,  method = "spearman")))) %>%
  select(-data) %>%
  unnest() %>%
  kable()
```

**References**

Bedny M, Koster-Hale J, Elli G, Yazzolino L, Saxe R (2019) There’s more to “sparkle” than meets the eye: Knowledge of vision and light verbs among congenitally blind and sighted individuals.  _Cognition_ 189:105–115.

Benesty, M. (2018). fastrtext: 'fastText' Wrapper for Text Classification and Word Representation (R package version 0.2.5). https://CRAN.R-project.org/package=fastrtext/

Bojanowski, P., Grave, E., Joulin, A., & Mikolov, T. (2016). Enriching word vectors with subword information. https://arxiv.org/abs/1607.04606

